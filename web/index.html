<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>人设切换插件管理</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --panel-2: #0b1220;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --primary: #22c55e;
      --primary-2: #16a34a;
      --danger: #ef4444;
      --danger-2: #dc2626;
      --warning: #f59e0b;
      --border: #1f2937;
      --chip: #1f2937;
      --chip-border: #374151; /* 新增：chip 专用边框色，更亮以便可见 */
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;
      background: linear-gradient(180deg, #0b1020, #0f172a 30% 70%, #0b1020);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      position: sticky; top: 0; z-index: 10;
      background: rgba(10, 15, 30, .7);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
    }
    .container { max-width: 1280px; margin: 0 auto; padding: 16px; }
    .row { display: flex; gap: 16px; }
    .col { background: linear-gradient(180deg, var(--panel), var(--panel-2)); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
    .col-left { width: 36%; min-width: 360px; }
    .col-right { flex: 1; }
    h1 { font-size: 18px; margin: 0; }
    h2 { font-size: 16px; margin: 12px 0; }
    .muted { color: var(--muted); }
    .toolbar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 8px; }
  .btn { height: 32px; padding: 0 12px; border-radius: 8px; border: 1px solid var(--border); background: #0b1220; color: var(--text); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap; }
  .btn-sm { height: 28px; padding: 0 10px; font-size: 12px; border-radius: 8px; white-space: nowrap; }
    .btn.primary { background: linear-gradient(180deg, var(--primary), var(--primary-2)); border: none; color: #052e16; font-weight: 600; }
    .btn.warn { background: linear-gradient(180deg, var(--warning), #b45309); border: none; color: #111; font-weight: 600; }
    .btn.danger { background: linear-gradient(180deg, var(--danger), var(--danger-2)); border: none; color: #fff; font-weight: 600; }
    .btn.info { background: linear-gradient(180deg, #3b82f6, #2563eb); border: none; color: #eaf2ff; font-weight: 600; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
  .help { display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; border-radius:50%; border:1px solid var(--border); color: var(--muted); font-weight:700; font-size:12px; margin-left:4px; cursor: help; background:#0b1220; }
  .help:hover { color: var(--text); border-color:#4b5563; background:#111827; }
    input[type="text"], input[type="search"], textarea, select {
      width: 100%; background: #0b1220; color: var(--text); border: 1px solid var(--border);
      border-radius: 8px; padding: 8px 10px; outline: none; min-height: 32px;
    }
    textarea { min-height: 80px; resize: vertical; }
    .list { display: grid; gap: 8px; margin-top: 8px; max-height: 60vh; overflow: auto; padding: 8px 14px 8px 8px; scrollbar-gutter: stable both-edges; }
    .item { padding: 10px; border: 1px solid var(--border); background: #0b1220; border-radius: 10px; cursor: pointer; }
    .item.active { outline: 2px solid var(--primary); outline-offset: -2px; }
    .item .title { font-weight: 600; }
    .item .meta { font-size: 12px; color: var(--muted); }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .g-6 { grid-column: span 6; }
    .g-4 { grid-column: span 4; }
    .g-12 { grid-column: span 12; }
    .key-row { display: flex; flex-direction: column; justify-content: flex-end; }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .chip {
      display: inline-flex; align-items: center; gap: 6px;
      height: 28px; padding: 0 10px; line-height: 1; font-size: 12px;
      background: var(--chip); border: 1px solid var(--chip-border); border-radius: 999px;
    }
    .chip .chip-label { display: inline-flex; align-items: center; line-height: 1; }
    .chip .chip-close {
      width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center;
      border: 1px solid var(--chip-border); background: #0b1220; color: var(--text);
      opacity: .85; cursor: pointer; border-radius: 6px; line-height: 1; font-size: 12px;
    }
    .chip .chip-close:hover { background: #1f2937; opacity: 1; border-color: #4b5563; }
    .chip .chip-close:focus { outline: none; box-shadow: 0 0 0 2px rgba(59,130,246,.35); }
    .table { width: 100%; border-collapse: collapse; }
  .table th, .table td { border-bottom: 1px solid var(--border); text-align: left; padding: 8px; vertical-align: middle; }
  .table th { white-space: nowrap; }
  .th-label { display: inline-flex; align-items: center; gap: 6px; }
  /* 触发词表格中的复选列居中（第3/4/5列） */
  .table th:nth-child(3), .table th:nth-child(4), .table th:nth-child(5),
  .table td:nth-child(3), .table td:nth-child(4), .table td:nth-child(5) { text-align: center; }
  /* 操作列按钮样式 */
  .table td:last-child { white-space: nowrap; }
  .table td:last-child .btn { margin-right: 4px; }
  /* 表格内标签垂直对齐 */
  .table .tag { vertical-align: middle; display: inline-flex; align-items: center; }
  /* 表格内选择框样式 */
  .table select { min-width: 100px; font-size: 12px; }
    .section { border: 1px dashed var(--border); border-radius: 10px; padding: 10px; }
    .split { display: flex; gap: 12px; align-items: center; }
    .right { margin-left: auto; }
    .small { font-size: 12px; color: var(--muted); }
    .note { padding: 8px; background: #0b1220; border: 1px solid var(--border); border-radius: 8px; }
    .kbd { background: #111827; border: 1px solid var(--border); padding: 2px 6px; border-radius: 6px; font-size: 12px; }
    .footer { color: var(--muted); padding: 12px; text-align: center; }
    .tag { display: inline-block; padding: 2px 6px; border-radius: 6px; background: #0b1220; border: 1px solid var(--border); font-size: 12px; margin-right: 6px; }
    .hidden { display: none !important; }

    /* 统一复选框样式 */
    input[type="checkbox"] {
      appearance: none; -webkit-appearance: none; -moz-appearance: none;
      width: 16px; height: 16px; border: 1.5px solid var(--border); border-radius: 4px;
      background: #0b1220; display: inline-grid; place-content: center; vertical-align: middle; cursor: pointer;
      transition: border-color .12s ease, background-color .12s ease, box-shadow .12s ease;
    }
    input[type="checkbox"]::before {
      content: ""; width: 10px; height: 10px; background: var(--primary); border-radius: 2px; transform: scale(0);
      transition: transform .12s ease;
    }
    input[type="checkbox"]:checked::before { transform: scale(1); }
    input[type="checkbox"]:focus { box-shadow: 0 0 0 3px rgba(34, 197, 94, .25); outline: none; }

    /* 统一滚动条样式 */
    * { scrollbar-width: thin; scrollbar-color: #374151 transparent; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #374151; border-radius: 8px; border: 2px solid transparent; background-clip: padding-box; }
    ::-webkit-scrollbar-thumb:hover { background: #4b5563; background-clip: padding-box; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="split">
        <h1>人设切换插件管理</h1>
        <div class="right toolbar">
          <button class="btn" id="refreshAll">刷新</button>
          <label class="btn warn" for="importFile">选择导入文件</label>
          <input id="importFile" type="file" accept="application/json" class="hidden" />
          <button class="btn warn" id="importBtn" disabled>开始导入</button>
        </div>
      </div>
      <div class="small" id="statBar">载入统计中…</div>
    </div>
  </header>

  <main class="container" id="app">
    <div class="row">
      <div class="col col-left">
        <h2>人设库</h2>
        <input type="search" id="presetSearch" placeholder="搜索人设（名称/描述/内容/标签）" />
        <div class="toolbar small">
          <span id="presetCount">0</span> 条结果
          <span class="right small">提示：可多选导出 · 支持标签模糊搜索</span>
        </div>
        <div class="list" id="presetList"></div>
        <div class="toolbar">
          <button class="btn info" id="selectAll">全选</button>
          <button class="btn primary" id="exportSelected" disabled>导出选中</button>
          <button class="btn warn" id="clearSelection" disabled>清除选择</button>
        </div>
        <div class="note small" style="margin-top:8px">
          说明：配置键用于在“人设设置”中索引配置，建议与数据库人设ID保持一致（如：1、2、3）。系统默认人设可使用“default”或名称。
        </div>
      </div>

      <div class="col col-right">
        <div class="grid">
          <div class="g-12">
            <h2>人设设置</h2>
            <div class="section">
              <div class="grid">
                <div class="g-6 key-row">
                  <label>配置键（preset_id）</label>
                  <input type="text" id="presetKey" placeholder="例如：1 或 default" />
                </div>
                <div class="g-6 key-row">
                  <label>&nbsp;</label>
                  <div class="toolbar">
                    <button class="btn primary" id="saveSetting">保存设置</button>
                    <button class="btn danger" id="deleteSetting">删除该设置</button>
                  </div>
                </div>
                <div class="g-6">
                  <label>白名单</label>
                  <div id="whitelistList" class="chips" style="min-height:38px"></div>
                  <div class="toolbar" style="margin-top:8px">
                    <select id="whitelistSelect"></select>
                    <button class="btn" id="addWhitelist">添加到白名单</button>
                  </div>
                  <div class="small muted" style="margin-top:6px">当AI尝试切换人设时，插件会根据白名单给出可用的人设供AI选择</div>
                </div>
                <div class="g-6">
                  <label>黑名单</label>
                  <div id="blacklistList" class="chips" style="min-height:38px"></div>
                  <div class="toolbar" style="margin-top:8px">
                    <select id="blacklistSelect"></select>
                    <button class="btn" id="addBlacklist">添加到黑名单</button>
                  </div>
                  <div class="small muted" style="margin-top:6px">当AI尝试切换人设时，插件会根据黑名单排除不可用的人设供AI选择</div>
                </div>
                <div class="g-12 split">
                  <div>
                    <input type="checkbox" id="sessionBlock" />
                    <label for="sessionBlock">人设隔离（该人设聊天记录独立存储）</label>
                  </div>
                </div>
                <div class="g-12">
                  <h3>触发词</h3>
      <table class="table">
                    <thead>
                      <tr>
                        <th style="width:35%">内容</th>
                        <th style="width:15%">模式</th>
                        <th style="width:10%"><span class="th-label">记录 <span class="help" title="触发时是否将该文本记录进会话历史，便于后续上下文使用">?</span></span></th>
                        <th style="width:12%"><span class="th-label">触发LLM <span class="help" title="切换到目标人设后，是否立即触发一次 LLM 回复">?</span></span></th>
                        <th style="width:12%"><span class="th-label">一次后还原 <span class="help" title="触发后仅本次聊天使用该人设，随后自动恢复原人设">?</span></span></th>
                        <th style="width:16%">操作</th>
                      </tr>
                    </thead>
                    <tbody id="triggerTable"></tbody>
                    <tfoot>
                      <tr>
                        <td><input type="text" id="twContent" placeholder="输入触发词" /></td>
                        <td>
                          <select id="twMode" style="min-width:90px;">
                            <option value="contains">包含</option>
                            <option value="equals">完全匹配</option>
                          </select>
                        </td>
                        <td><input type="checkbox" id="twRecord" checked /></td>
        <td><input type="checkbox" id="twTriggerLLM" /></td>
        <td><input type="checkbox" id="twChatOnce" title="触发后仅一次聊天，随后切回原人设" /></td>
                        <td><button class="btn btn-sm" id="addTrigger">添加</button></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="g-12">
            <h2>会话任务管理</h2>
            <div class="section">
              <div class="toolbar">
                <button class="btn" id="refreshTasks">刷新任务</button>
                <input type="search" id="taskSearch" placeholder="搜索 chat_key 或任务内容" />
              </div>
              <table class="table" style="margin-top:8px">
                <thead>
                  <tr>
                    <th style="width:30%">chat_key</th>
                    <th>任务内容</th>
                    <th style="width:220px">操作</th>
                  </tr>
                </thead>
                <tbody id="taskTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top: 16px;" class="small muted">
      小提示：
      <span class="tag">保存设置</span> 会立即写入配置文件；
      <span class="tag">清空任务</span> 仅将内容置空，
      <span class="tag">删除任务</span> 会移除该会话任务键。
    </div>
  </main>

  <div class="footer">Nekro Agent · 人设切换插件 · WebUI</div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    const api = {
      getPresets: () => fetch('presets').then(r => r.json()),
      getPresetSettings: () => fetch('preset-settings').then(r => r.json()),
      getPresetSetting: async (id) => {
        const res = await fetch(`preset-settings/${encodeURIComponent(id)}`);
        if (res.ok) return res.json();
        if (res.status === 404) return null;
        throw new Error(await res.text());
      },
      savePresetSetting: (id, data) => fetch(`preset-settings/${encodeURIComponent(id)}`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
      }).then(async r => {
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      }),
      deletePresetSetting: (id) => fetch(`preset-settings/${encodeURIComponent(id)}`, { method: 'DELETE' }).then(async r => {
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      }),
      getTasks: () => fetch('tasks').then(r => r.json()),
      deleteTask: (chatKey) => fetch(`tasks/${encodeURIComponent(chatKey)}`, { method: 'DELETE' }).then(async r => { if (!r.ok) throw new Error(await r.text()); return r.json(); }),
      clearTask: (chatKey) => fetch(`tasks/${encodeURIComponent(chatKey)}/clear`, { method: 'POST' }).then(async r => { if (!r.ok) throw new Error(await r.text()); return r.json(); }),
      getStats: () => fetch('statistics').then(r => r.json()),
      exportAll: () => window.open('export-presets', '_blank'),
      exportIds: (ids) => window.open(`export-preset/${ids.join(',')}`, '_blank'),
      importPresets: async (file) => {
        const fd = new FormData();
        fd.append('file', file);
        const res = await fetch('import-presets', { method: 'POST', body: fd });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }
    };

    const state = {
      presets: [], // [{id,name,description,content}]
      presetSettings: {}, // { [key]: PresetItemResponse }
      selectedPresetKeys: new Set(), // checkbox selections for export
      activePresetKey: '',
      triggers: [], // working copy for UI
      searchText: '',
      tasks: [],
      taskSearch: '',
      importFile: null,
      whitelist: [],
      blacklist: [],
      editingTriggerIndex: -1, // 正在编辑的触发词索引，-1表示没有编辑
    };

    function setStatBar(text) { $('#statBar').textContent = text; }

    function showToast(text, type = 'info') {
      console.log(`[${type}]`, text);
      const color = type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--primary)' : 'var(--warning)';
      const bar = document.createElement('div');
      bar.textContent = text;
      bar.style.position = 'fixed';
      bar.style.bottom = '20px';
      bar.style.right = '20px';
      bar.style.background = '#0b1220';
      bar.style.border = `1px solid ${color}`;
      bar.style.padding = '10px 12px';
      bar.style.borderRadius = '10px';
      bar.style.zIndex = '9999';
      document.body.appendChild(bar);
      setTimeout(() => bar.remove(), 2200);
    }

    function parseListInput(value) {
      if (!value) return null; // 保持为空即不设置
      const arr = value
        .split(/\n|,|;|\s+/)
        .map(s => s.trim())
        .filter(Boolean);
      return arr.length ? arr : null;
    }

    // 辅助函数：检查搜索词是否匹配 tags 字段
    function matchesTags(tags, searchText) {
      if (!tags || !searchText) return false;
      // 将 tags 字符串按逗号分割成数组，去掉空白
      const tagArray = tags.split(',').map(tag => tag.trim().toLowerCase()).filter(Boolean);
      const searchLower = searchText.toLowerCase();
      
      // 检查是否有任何标签包含搜索文本
      return tagArray.some(tag => tag.includes(searchLower));
    }

    // 辅助函数：渲染标签，高亮匹配的部分
    function renderTagsWithHighlight(tags, searchText) {
      if (!tags) return '';
      
      const tagArray = tags.split(',').map(tag => tag.trim()).filter(Boolean);
      const searchLower = searchText ? searchText.toLowerCase() : '';
      
      return tagArray.map(tag => {
        let tagHtml = escapeHtml(tag);
        
        // 如果有搜索文本且标签匹配，则高亮显示
        if (searchLower && tag.toLowerCase().includes(searchLower)) {
          // 创建一个安全的正则表达式，转义特殊字符
          const escapedSearch = searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const regex = new RegExp(`(${escapedSearch})`, 'gi');
          tagHtml = tagHtml.replace(regex, '<mark style="background: var(--primary); color: #052e16; padding: 1px 2px; border-radius: 2px;">$1</mark>');
        }
        
        return `<span class="tag">${tagHtml}</span>`;
      }).join(' ');
    }

    function renderPresetList() {
      const list = $('#presetList');
      list.innerHTML = '';
      const q = state.searchText.trim().toLowerCase();
      const filtered = state.presets.filter(p => {
        if (!q) return true;
        return (
          (p.name || '').toLowerCase().includes(q) ||
          (p.description || '').toLowerCase().includes(q) ||
          (p.content || '').toLowerCase().includes(q) ||
          (String(p.id || '')).includes(q) ||
          matchesTags(p.tags, q)
        );
      });
      $('#presetCount').textContent = String(filtered.length);
      filtered.forEach(p => {
        const keyById = p.id != null ? String(p.id) : '';
        const item = document.createElement('div');
        item.className = 'item';
        
        // 渲染标签（如果存在），带高亮效果
        const tagsHtml = p.tags ? renderTagsWithHighlight(p.tags, state.searchText.trim()) : '';
        
        item.innerHTML = `
          <div class="split">
            <div>
              <div class="title">${escapeHtml(p.name || '(未命名)')}</div>
              <div class="meta">ID: ${p.id ?? 'default'}${p.description ? ' · ' + escapeHtml(p.description) : ''}</div>
              ${tagsHtml ? `<div class="meta" style="margin-top:4px">${tagsHtml}</div>` : ''}
            </div>
            <div class="right split">
              <input type="checkbox" ${state.selectedPresetKeys.has(keyById) ? 'checked' : ''} ${keyById ? '' : 'disabled'} style="margin-right:8px" />
            </div>
          </div>
        `;
        const checkbox = item.querySelector('input[type="checkbox"]');
        checkbox?.addEventListener('change', (e) => {
          if (!keyById) return;
          if (e.target.checked) state.selectedPresetKeys.add(keyById);
          else state.selectedPresetKeys.delete(keyById);
          updateExportButtons();
        });
        item.addEventListener('click', (e) => {
          // 避免点击复选框时重复触发
          if (e.target.type === 'checkbox') return;
          const suggestedKey = keyById || (p.name || 'default');
          $('#presetKey').value = String(suggestedKey);
          loadPresetSettingToEditor(String(suggestedKey));
          $$('#presetList .item').forEach(it => it.classList.remove('active'));
          item.classList.add('active');
        });
        list.appendChild(item);
      });
      updateExportButtons();
    }

    function updateExportButtons() {
      const hasSel = state.selectedPresetKeys.size > 0;
      $('#exportSelected').disabled = !hasSel;
      $('#clearSelection').disabled = !hasSel;
    }

    function renderTriggers() {
      const tbody = $('#triggerTable');
      tbody.innerHTML = '';
      state.triggers.forEach((tw, idx) => {
        const tr = document.createElement('tr');
        
        // 如果当前行正在编辑，显示编辑表单
        if (state.editingTriggerIndex === idx) {
          tr.innerHTML = `
            <td><input type="text" id="editTwContent" value="${escapeHtml(tw.content)}" style="width:100%" /></td>
            <td>
              <select id="editTwMode" style="width:100%; min-width:90px;">
                <option value="contains" ${tw.trigger_mode === 'contains' ? 'selected' : ''}>包含</option>
                <option value="equals" ${tw.trigger_mode === 'equals' ? 'selected' : ''}>完全匹配</option>
              </select>
            </td>
            <td style="text-align:center"><input type="checkbox" id="editTwRecord" ${tw.is_record ? 'checked' : ''} /></td>
            <td style="text-align:center"><input type="checkbox" id="editTwTriggerLLM" ${tw.is_trigger_llm ? 'checked' : ''} /></td>
            <td style="text-align:center"><input type="checkbox" id="editTwChatOnce" ${tw.is_chat_once ? 'checked' : ''} /></td>
            <td>
              <button class="btn btn-sm primary" data-action="save" data-idx="${idx}">保存</button>
              <button class="btn btn-sm" data-action="cancel" data-idx="${idx}">取消</button>
            </td>
          `;
        } else {
          // 正常显示模式
          tr.innerHTML = `
            <td>${escapeHtml(tw.content)}</td>
            <td><span class="tag">${tw.trigger_mode === 'equals' ? '完全匹配' : '包含'}</span></td>
            <td>${tw.is_record ? '是' : '否'}</td>
            <td>${tw.is_trigger_llm ? '<span class="tag">触发</span>' : '不触发'}</td>
            <td>${tw.is_chat_once ? '<span class="tag">一次</span>' : '否'}</td>
            <td>
              <button class="btn btn-sm info" data-action="edit" data-idx="${idx}">编辑</button>
              <button class="btn btn-sm danger" data-action="delete" data-idx="${idx}">删除</button>
            </td>
          `;
        }
        
        // 绑定事件
        const buttons = tr.querySelectorAll('button');
        buttons.forEach(btn => {
          const action = btn.dataset.action;
          const idx = parseInt(btn.dataset.idx);
          
          btn.addEventListener('click', () => {
            if (action === 'edit') {
              state.editingTriggerIndex = idx;
              renderTriggers();
            } else if (action === 'delete') {
              state.triggers.splice(idx, 1);
              state.editingTriggerIndex = -1; // 重置编辑状态
              renderTriggers();
            } else if (action === 'save') {
              const content = $('#editTwContent').value.trim();
              const mode = $('#editTwMode').value;
              const isRecord = $('#editTwRecord').checked;
              const isTrigger = $('#editTwTriggerLLM').checked;
              const isChatOnce = $('#editTwChatOnce').checked;
              
              if (!content) {
                showToast('请输入触发词内容', 'warning');
                return;
              }
              
              // 更新触发词
              state.triggers[idx] = {
                content,
                trigger_mode: mode,
                is_record: isRecord,
                is_trigger_llm: isTrigger,
                is_chat_once: isChatOnce
              };
              
              state.editingTriggerIndex = -1;
              renderTriggers();
              showToast('触发词已更新', 'success');
            } else if (action === 'cancel') {
              state.editingTriggerIndex = -1;
              renderTriggers();
            }
          });
        });
        
        tbody.appendChild(tr);
      });
    }

    function updateSelectOptions(kind) {
      const isWhite = kind === 'white';
      const select = isWhite ? $('#whitelistSelect') : $('#blacklistSelect');
      const selected = new Set(isWhite ? state.whitelist : state.blacklist);

      // 普通候选（有数值 ID 的人设）
      const normalCandidates = state.presets
        .filter(p => p.id != null && !selected.has(String(p.id)))
        .sort((a,b) => Number(a.id) - Number(b.id));

      // 默认人设候选（id 为 null，在配置中用 'default' 表示）
      const defaultPreset = state.presets.find(p => p.id == null);
      const canAddDefault = !!defaultPreset && !selected.has('default');

      select.innerHTML = '';
      if (canAddDefault) {
        const opt = document.createElement('option');
        opt.value = 'default';
        opt.textContent = `ID default · ${defaultPreset.name || '默认人设'}`;
        select.appendChild(opt);
      }
      normalCandidates.forEach(p => {
        const opt = document.createElement('option');
        opt.value = String(p.id);
        opt.textContent = `ID ${p.id} · ${p.name || ''}`.trim();
        select.appendChild(opt);
      });

      if (!select.children.length) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '无可添加项';
        select.appendChild(opt);
      }

      const addBtn = isWhite ? $('#addWhitelist') : $('#addBlacklist');
      addBtn.disabled = !select.children.length || select.value === '';
    }

    function renderIdList(kind) {
      const isWhite = kind === 'white';
      const wrap = isWhite ? $('#whitelistList') : $('#blacklistList');
      const list = isWhite ? state.whitelist : state.blacklist;
      wrap.innerHTML = '';
      const nameById = new Map();
      // 映射普通人设
      state.presets.filter(p => p.id != null).forEach(p => nameById.set(String(p.id), p.name || ''));
      // 映射默认人设
      const defaultPreset = state.presets.find(p => p.id == null);
      if (defaultPreset) nameById.set('default', defaultPreset.name || '默认人设');

      (list || []).forEach((id, idx) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        const name = nameById.get(String(id));
        chip.innerHTML = `<span class="chip-label">${escapeHtml(String(id))}${name ? ' · ' + escapeHtml(name) : ''}</span><button class="chip-close" aria-label="删除" title="删除">×</button>`;
        chip.querySelector('.chip-close')?.addEventListener('click', () => {
          const arr = isWhite ? state.whitelist : state.blacklist;
          arr.splice(idx, 1);
          renderIdList(kind);
        });
        wrap.appendChild(chip);
      });
      updateSelectOptions(kind);
    }

    async function loadAll() {
      try {
        setStatBar('载入中…');
        const [presets, presetSettings, stats, tasks] = await Promise.all([
          api.getPresets(), api.getPresetSettings(), api.getStats(), api.getTasks()
        ]);
        state.presets = presets || [];
        state.presetSettings = presetSettings || {};
        state.tasks = tasks || [];
        renderPresetList();
        renderTasks();
        applyStats(stats);
        setStatBar(`人设设置：${stats.total_preset_settings} · 活跃任务：${stats.active_tasks}/${stats.total_task_sessions} · 触发词：${stats.total_trigger_words}`);
      } catch (e) {
        console.error(e);
        showToast('初始化失败：' + (e.message || e), 'error');
      }
    }

    function applyStats(stats) {
      if (!stats) return;
      setStatBar(`人设设置：${stats.total_preset_settings} · 活跃任务：${stats.active_tasks}/${stats.total_task_sessions} · 触发词：${stats.total_trigger_words}`);
    }

    async function loadPresetSettingToEditor(key) {
      try {
        state.activePresetKey = key;
        state.editingTriggerIndex = -1; // 重置编辑状态
        const setting = await api.getPresetSetting(key);
        if (!setting) {
          state.whitelist = [];
          state.blacklist = [];
          $('#sessionBlock').checked = false;
          state.triggers = [];
          renderTriggers();
          renderIdList('white');
          renderIdList('black');
          return;
        }
        state.whitelist = (setting.whitelist || []).map(String);
        state.blacklist = (setting.blacklist || []).map(String);
        $('#sessionBlock').checked = !!setting.preset_session_block;
        state.triggers = (setting.trigger_words || []).map(x => ({
          content: x.content,
          is_record: !!x.is_record,
          trigger_mode: x.trigger_mode || 'contains',
          is_trigger_llm: !!x.is_trigger_llm,
          is_chat_once: !!x.is_chat_once,
        }));
        renderTriggers();
        renderIdList('white');
        renderIdList('black');
      } catch (e) {
        showToast('加载人设设置失败：' + (e.message || e), 'error');
      }
    }

    function collectSettingFromEditor() {
      return {
        whitelist: state.whitelist.length ? state.whitelist : null,
        blacklist: state.blacklist.length ? state.blacklist : null,
        trigger_words: state.triggers.map(tw => ({
          content: tw.content,
          is_record: !!tw.is_record,
          trigger_mode: tw.trigger_mode || 'contains',
          is_trigger_llm: !!tw.is_trigger_llm,
          is_chat_once: !!tw.is_chat_once,
        })),
        preset_session_block: $('#sessionBlock').checked,
      };
    }

    function renderTasks() {
      const tbody = $('#taskTable');
      tbody.innerHTML = '';
      const q = (state.taskSearch || '').toLowerCase();
      const filtered = state.tasks.filter(t => !q || String(t.chat_key).toLowerCase().includes(q) || String(t.task_content || '').toLowerCase().includes(q));
      filtered.forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="kbd">${escapeHtml(String(t.chat_key))}</span></td>
          <td class="small">${escapeHtml((t.task_content || '').slice(0, 200))}${(t.task_content || '').length > 200 ? '…' : ''}</td>
          <td>
            <div class="toolbar">
              <button class="btn" data-action="view">查看</button>
              <button class="btn warn" data-action="clear">清空</button>
              <button class="btn danger" data-action="delete">删除</button>
            </div>
          </td>`;
        tr.querySelector('[data-action="view"]').addEventListener('click', () => {
          const txt = t.task_content || '';
          navigator.clipboard?.writeText(txt).catch(()=>{});
          alert(`chat_key: ${t.chat_key}\n\n任务内容：\n\n${txt}`);
        });
        tr.querySelector('[data-action="clear"]').addEventListener('click', async () => {
          if (!confirm(`确认清空会话任务？\n${t.chat_key}`)) return;
          try { await api.clearTask(t.chat_key); showToast('已清空', 'success'); await refreshTasks(); } catch (e) { showToast('清空失败：' + (e.message || e), 'error'); }
        });
        tr.querySelector('[data-action="delete"]').addEventListener('click', async () => {
          if (!confirm(`确认删除会话任务？\n${t.chat_key}`)) return;
          try { await api.deleteTask(t.chat_key); showToast('已删除', 'success'); await refreshTasks(); } catch (e) { showToast('删除失败：' + (e.message || e), 'error'); }
        });
        tbody.appendChild(tr);
      });
    }

    async function refreshTasks() {
      try { state.tasks = await api.getTasks(); renderTasks(); } catch (e) { showToast('刷新任务失败：' + (e.message || e), 'error'); }
    }

    // Helpers
    function escapeHtml(str) {
      return String(str || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // Events
    $('#presetSearch').addEventListener('input', (e) => { state.searchText = e.target.value; renderPresetList(); });
    $('#taskSearch').addEventListener('input', (e) => { state.taskSearch = e.target.value; renderTasks(); });

    $('#addTrigger').addEventListener('click', () => {
      const content = $('#twContent').value.trim();
      const mode = $('#twMode').value;
      const isRecord = $('#twRecord').checked;
      const isTrigger = $('#twTriggerLLM').checked;
      const isChatOnce = $('#twChatOnce').checked;
      if (!content) { showToast('请输入触发词内容', 'warning'); return; }
      
      // 如果正在编辑其他触发词，先取消编辑状态
      state.editingTriggerIndex = -1;
      
      state.triggers.push({ content, trigger_mode: mode, is_record: isRecord, is_trigger_llm: isTrigger, is_chat_once: isChatOnce });
      $('#twContent').value = '';
      $('#twTriggerLLM').checked = false;
      $('#twChatOnce').checked = false;
      renderTriggers();
    });

    $('#saveSetting').addEventListener('click', async () => {
      const key = $('#presetKey').value.trim();
      if (!key) { showToast('请填写配置键（preset_id）', 'warning'); return; }
      const payload = collectSettingFromEditor();
      try {
        await api.savePresetSetting(key, payload);
        showToast('保存成功', 'success');
        state.presetSettings[key] = payload; // 乐观更新
        // 刷新统计
        applyStats(await api.getStats());
      } catch (e) {
        showToast('保存失败：' + (e.message || e), 'error');
      }
    });

    $('#deleteSetting').addEventListener('click', async () => {
      const key = $('#presetKey').value.trim();
      if (!key) { showToast('请先填写配置键', 'warning'); return; }
      if (!confirm(`确认删除该人设设置？\n${key}`)) return;
      try {
        await api.deletePresetSetting(key);
        showToast('已删除', 'success');
        delete state.presetSettings[key];
        // 清空编辑器
        state.whitelist = [];
        state.blacklist = [];
        $('#sessionBlock').checked = false;
        state.editingTriggerIndex = -1; // 重置编辑状态
        state.triggers = []; renderTriggers();
        renderIdList('white');
        renderIdList('black');
        applyStats(await api.getStats());
      } catch (e) {
        showToast('删除失败：' + (e.message || e), 'error');
      }
    });

    $('#refreshAll').addEventListener('click', async () => { await loadAll(); });

    // 新增：导入文件选择与导入处理
    $('#importFile').addEventListener('change', (e) => {
      const input = e.target;
      const file = input && input.files && input.files[0] ? input.files[0] : null;
      state.importFile = file;
      $('#importBtn').disabled = !file;
      const label = document.querySelector('label[for="importFile"]');
      if (label) label.textContent = file ? `已选择：${file.name}` : '选择导入文件';
    });

    $('#importBtn').addEventListener('click', async () => {
      if (!state.importFile) { showToast('请先选择要导入的 JSON 文件', 'warning'); return; }
      const btn = $('#importBtn');
      btn.disabled = true;
      const prevText = btn.textContent;
      btn.textContent = '导入中…';
      try {
        const res = await api.importPresets(state.importFile);
        showToast('导入完成', 'success');
        // 重置文件选择
        $('#importFile').value = '';
        state.importFile = null;
        const label = document.querySelector('label[for="importFile"]');
        if (label) label.textContent = '选择导入文件';
        // 刷新数据
        await loadAll();
      } catch (e) {
        showToast('导入失败：' + (e.message || e), 'error');
      } finally {
        btn.textContent = prevText;
        btn.disabled = !state.importFile;
      }
    });

    // 顶部“导出全部人设”按钮已移除
    // $('#exportAll').addEventListener('click', () => api.exportAll());
    $('#exportSelected').addEventListener('click', () => {
      const ids = Array.from(state.selectedPresetKeys);
      if (!ids.length) return;
      api.exportIds(ids);
    });
    $('#clearSelection').addEventListener('click', () => { state.selectedPresetKeys.clear(); renderPresetList(); });
    $('#selectAll').addEventListener('click', () => {
      const q = state.searchText.trim().toLowerCase();
      const filtered = state.presets.filter(p => {
        if (!q) return true;
        return (
          (p.name || '').toLowerCase().includes(q) ||
          (p.description || '').toLowerCase().includes(q) ||
          (p.content || '').toLowerCase().includes(q) ||
          (String(p.id || '')).includes(q) ||
          matchesTags(p.tags, q)
        );
      });
      filtered.forEach(p => { if (p.id != null) state.selectedPresetKeys.add(String(p.id)); });
      renderPresetList();
    });
    $('#refreshTasks').addEventListener('click', refreshTasks);

    $('#addWhitelist').addEventListener('click', () => {
      const v = $('#whitelistSelect').value;
      if (!v) return;
      if (!state.whitelist.includes(v)) state.whitelist.push(v);
      renderIdList('white');
    });
    $('#addBlacklist').addEventListener('click', () => {
      const v = $('#blacklistSelect').value;
      if (!v) return;
      if (!state.blacklist.includes(v)) state.blacklist.push(v);
      renderIdList('black');
    });

    // Boot
    loadAll().then(() => {
      // 初始化下拉可选项
      renderIdList('white');
      renderIdList('black');
    });
  </script>
</body>
</html>
